const https = require('https');
const { sendSlackAlert } = require('./slack-bot');

const websiteUrl = 'client.manduu.work';

function checkWebsiteStatus() {
  const options = {
    method: 'GET',
    hostname: websiteUrl,
  };

  const start = Date.now(); // Record the start time before making the request

  const req = https.request(options, (res) => {
    const end = Date.now(); // Record the end time when the response is received
    const responseTime = end - start; // Calculate the response time in milliseconds

    let alertMessage;

    if (res.statusCode === 200) {
      alertMessage = `Server Status: Online\nResponse Time: ${responseTime} ms`;
    } else {
      alertMessage = `Server Status: Offline\nHTTP Status Code: ${res.statusCode}\nResponse Time: ${responseTime} ms`;
    }

    // You can add more detailed checks here for high server load, slow response time, etc.
    if (responseTime > 5000) {
      alertMessage += '\nHigh Server Load Detected';
    }

    if (res.statusCode !== 200) {
      alertMessage += '\nError Details: <Add error details here>';
    }

    console.log(alertMessage);
    sendSlackAlert(alertMessage); // Send a comprehensive alert message to Slack
  });

  req.on('error', (err) => {
    const errorMessage = `Server Status: Offline\nError: ${err.message}`;
    console.error(errorMessage);
    sendSlackAlert(errorMessage); // Send an alert with the error message
  });

  req.end();
}

setInterval(checkWebsiteStatus, 60 * 1000); // Check the website status every minute

module.exports = {
  checkWebsiteStatus,
};
